# PDF Comic Editor - Claude Development Context

## Project Overview
This is a **Linux desktop application (open source)** for writers and editors to create and edit books with custom styling. Features include professional PDF generation, multi-resolution image handling with positioning control, customizable templates per page, and color palette systems for environmental storytelling.

## ðŸ“‹ DEVELOPMENT PLAN
**IMPORTANT**: Follow the complete 10-phase development plan documented in `.docs/development-plan.md`

### Current Objective - Linux Desktop Application
Develop a complete **native book authoring application** with:
- **Native Linux App**: Built with Electron + React + TypeScript
- **Offline-First**: Works completely without internet connection
- **Local Storage**: SQLite database in user's home directory
- **File Format**: Custom `.pdfbook` format for projects
- **Multi-Project**: Manage multiple books in local workspace
- **Custom Styling**: Full creative control with Monaco Editor
- **Professional PDF**: High-fidelity output for printing
- **Multi-Resolution Images**: Precise positioning and optimization
- **Template System**: Local library with community templates
- **Color Palettes**: Environmental storytelling themes
- **Auto-Save & Versioning**: Local backups every 10 minutes
- **Open Source**: GPL v3 license, community contributions

### Target Users
1. **Individual Writers**: Novelists, poets, short story authors
2. **Children's Book Authors**: Colorful designs with large images  
3. **Technical Writers**: Documentation, manuals, guides
4. **Self-Publishers**: Print-ready PDFs and digital ePubs
5. **Educators**: Textbooks, study materials
6. **Content Creators**: Compiling blog posts into books
7. **Linux Enthusiasts**: Privacy-focused, offline-capable tool

### Distribution Model
- **Open Source**: Free software, GPL v3 license
- **Package Formats**: .deb (Ubuntu/Debian), .AppImage (universal), .tar.gz
- **Installation**: Available via apt repository and GitHub releases
- **Community**: GitHub for issues, contributions, feature requests

## Architecture - Desktop Application
- **Framework**: Electron + React 18 + TypeScript
- **UI**: Tailwind CSS + Headless UI + Lucide Icons
- **Editor**: Monaco Editor (VS Code editor engine)
- **Canvas**: Fabric.js + Konva.js for visual manipulation
- **Database**: SQLite3 + better-sqlite3 (local storage)
- **PDF Engine**: Puppeteer + html2canvas
- **Images**: Sharp for processing and optimization
- **Build**: Electron Builder for Linux packages (.deb/.AppImage)

## Database Schema

### Core Tables (Local SQLite)
```sql
-- Application settings
CREATE TABLE app_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT UNIQUE NOT NULL,
    value TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Projects (local, no users)
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    file_path TEXT, -- path to .pdfbook file
    page_format TEXT DEFAULT 'A4',
    page_orientation TEXT DEFAULT 'portrait',
    margins TEXT DEFAULT '{"top":20,"bottom":20,"left":20,"right":20}',
    color_palette_id INTEGER,
    word_count INTEGER DEFAULT 0,
    page_count INTEGER DEFAULT 0,
    last_export_path TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_accessed DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Version history (auto-backup)
CREATE TABLE project_versions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER REFERENCES projects(id),
    version_number INTEGER NOT NULL,
    description TEXT DEFAULT 'Auto-save',
    data_snapshot TEXT, -- JSON snapshot
    file_size INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Pages table
CREATE TABLE pages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER REFERENCES projects(id),
    page_number INTEGER NOT NULL,
    name TEXT DEFAULT 'PÃ¡gina',
    html_content TEXT DEFAULT '',
    css_styles TEXT DEFAULT '',
    page_config TEXT DEFAULT '{}',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Assets table (stores images as BLOBs)
CREATE TABLE assets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER REFERENCES projects(id),
    filename TEXT NOT NULL,
    original_name TEXT NOT NULL,
    mime_type TEXT NOT NULL,
    file_size INTEGER,
    file_data BLOB NOT NULL,
    width INTEGER,
    height INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Global styles
CREATE TABLE global_styles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER REFERENCES projects(id),
    css_content TEXT DEFAULT '',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Templates
CREATE TABLE templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category TEXT DEFAULT 'general',
    html_template TEXT NOT NULL,
    css_template TEXT NOT NULL,
    preview_image BLOB,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Color palettes for environmental theming
CREATE TABLE color_palettes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    colors TEXT NOT NULL, -- JSON array de colores
    theme_type TEXT DEFAULT 'custom', -- vintage, modern, infantil, etc.
    is_default BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Key Components

### Frontend
- **PageCanvas**: Main canvas with drag & drop functionality
- **ElementToolbar**: Text, image, shapes editing tools
- **StylePanel**: Real-time CSS properties panel
- **CodeEditor**: Monaco Editor for direct HTML/CSS editing
- **AssetManager**: Multi-resolution image and resource manager
- **TemplateSelector**: Template library and customization
- **ColorPaletteManager**: Environmental color theme system

### Backend Services
- **ProjectService**: CRUD operations for projects
- **PageService**: Page management and content updates
- **AssetService**: Multi-resolution file upload, processing, and BLOB storage
- **PDFGenerator**: High-fidelity HTML to PDF conversion using Puppeteer
- **TemplateService**: Template management and per-page customization
- **ColorPaletteService**: Theme and palette management

## Development Commands

When working on this project, use these commands:

### Backend Development
```bash
cd backend
npm run dev          # Start development server
npm run build        # Build TypeScript
npm run test         # Run tests
npm run lint         # ESLint check
npm run typecheck    # TypeScript check
```

### Frontend Development
```bash
cd frontend
npm start            # Start development server
npm run build        # Build for production
npm test             # Run tests
npm run lint         # ESLint check
npm run typecheck    # TypeScript check
```

## Key Technical Features

### Visual Editor
- Drag & drop elements using React-DnD
- Resizing handles with Fabric.js
- In-line text editing (double-click)
- Grid system for precise alignment
- Undo/Redo system

### Asset Management
- Automatic upload via drag & drop
- Image optimization with Sharp
- BLOB storage in SQLite
- Virtual asset URLs (asset://project-id/asset-id)
- Supported formats: PNG, JPG, SVG, GIF

### PDF Generation
- Puppeteer-based HTML to PDF conversion
- CSS @page rules for print formatting
- Embedded assets as data URLs
- Custom margins, headers, footers
- High-fidelity rendering

### Performance Optimizations
- Lazy loading of pages
- Debounced auto-save (500ms)
- Asset caching and compression
- Virtual scrolling for large projects
- Connection pooling for SQLite

## API Structure

### Main Endpoints
- `POST /api/projects` - Create new project
- `GET /api/projects/:id` - Get project details
- `PUT /api/projects/:id` - Update project
- `DELETE /api/projects/:id` - Delete project
- `POST /api/projects/:id/pages` - Add page
- `PUT /api/pages/:pageId` - Update page content
- `POST /api/projects/:id/assets` - Upload asset
- `POST /api/projects/:id/generate-pdf` - Generate final PDF

## Workflow

1. **Project Creation**: User creates project â†’ SQLite INSERT â†’ Initialize workspace
2. **Content Editing**: User modifies â†’ React state â†’ Debounced API call â†’ SQLite UPDATE
3. **Asset Upload**: Drag image â†’ FormData POST â†’ Sharp processing â†’ BLOB storage
4. **PDF Generation**: Compile all pages â†’ Embed assets â†’ Puppeteer render â†’ PDF buffer

## Development Notes

- Use TypeScript for all new code
- Follow existing component patterns
- Implement proper error handling
- Add loading states for async operations
- Optimize database queries with proper indexes
- Test PDF generation with various content types
- Ensure responsive design for editor interface

## Testing Strategy

- Unit tests for services and utilities
- Integration tests for API endpoints
- Component tests for React components
- E2E tests for critical user flows
- PDF generation testing with sample content

## Security Considerations

- Input sanitization for HTML content
- File type validation for uploads
- Size limits for assets
- SQL injection prevention
- XSS protection in editor